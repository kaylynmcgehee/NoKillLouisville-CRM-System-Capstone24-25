@page "/Notifications/View"

@using Microsoft.AspNetCore.Authorization
@using No_Kill_Inventory.Data
@inject ApplicationDbContext Context
@rendermode InteractiveServer

@attribute [Authorize]

<AuthorizeView>
    <MudTable T="Notification" Items="@TotalNotifications" Hover="true">
        <HeaderContent>
            <MudTh>Expiration Form Type</MudTh>
            <MudTh>Days Until Expiration</MudTh>
            <MudTh>Expiration Date</MudTh>
        </HeaderContent>
        <RowTemplate Context ="item">
            <MudTd>@item.notification</MudTd>
            <MudTd>@item.DaysLeft</MudTd>
            <MudTd>@item.Expiration.ToString("MM/dd/yyyy")</MudTd>
        </RowTemplate>
    </MudTable>
</AuthorizeView>

@code {
    private List<Notification> TotalNotifications = new List<Notification>();

    public enum NotificationType
    {
        Application,
        ProofOfIncome,
        SpayNeuter,
        FoodExpiration
    }

    private struct Notification
    {
        public Notification(NotificationType notification, int daysLeft, DateTime expiration)
        {
            this.notification = notification;
            DaysLeft = daysLeft;
            Expiration = expiration;
        }
        public NotificationType notification;
        public int DaysLeft;
        public DateTime Expiration;
    }

    private void GetFoodNotifications()
    {
        foreach (var item in Context.FoodPallets)
        {
            if ((item.ExpirationDate - DateTime.Today).TotalDays <= 7 && item.Status == Status.Alive)
            {
                var p1 = new Notification(NotificationType.FoodExpiration, (int)(item.ExpirationDate - DateTime.Today).TotalDays, item.ExpirationDate.Date);
                TotalNotifications.Add(p1);
            }
        }
        Console.WriteLine(TotalNotifications);
    }
    
    protected override async Task OnInitializedAsync()
    {
        GetFoodNotifications();
    }
}