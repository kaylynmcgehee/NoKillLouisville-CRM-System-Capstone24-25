@page "/Recipients/Entry"

@using System.ComponentModel.DataAnnotations
@using No_Kill_Inventory.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore

@inject ApplicationDbContext Context

@attribute [Authorize]

<PageTitle>Register</PageTitle>

<AuthorizeView>
    <Authorized>
        <h1>Add Recipient</h1>

        <!-- Search Section -->
        <MudPaper Class="pa-4 mb-4">
            <MudText Typo="Typo.h5">Search Recipients</MudText>

            <MudTextField @bind-Value="searchTerm" Placeholder="Enter recipient name..." Immediate="true" Class="mb-2" />
            
            @if (filteredRecipients.Any())
            {
                @foreach (var recipient in filteredRecipients)
                {
                    <MudPaper Class="pa-2 mb-2">
    <MudText Typo="Typo.subtitle2">@recipient.FirstName @recipient.LastName</MudText>
    <MudText Typo="Typo.body2">@recipient.PhoneNumber</MudText>

    <div class="d-flex flex-wrap gap-2 mt-1">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => SelectRecipient(recipient))">
            Select Recipient
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="@(() => ShowAppointmentDate(recipient))">
            Show Last Appointment
        </MudButton>
    </div>

    @if (recipientToShowDate?.Id == recipient.Id)
    {
        <MudText Typo="Typo.caption" Class="mt-1">
            Last Appointment Date: @(string.IsNullOrWhiteSpace(recipient.LastAppointmentDate) ? "N/A" : recipient.LastAppointmentDate)
        </MudText>
    }
</MudPaper>

                }
            }
            else if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                <MudText>No recipients found.</MudText>
            }

        </MudPaper>

        <!-- Recipient Info Section (Always visible) -->
        <MudGrid>
            <MudItem xs="12" sm="7">
                <MudPaper Class="pa-4">
                    <MudForm @ref="recipientForm" @bind-IsValid="@recipientSuccess" @bind-Errors="@errors" OnValidSubmit="AddRecipient">
                        <MudText Typo="Typo.h5">Add New Recipient</MudText>

                        <MudTextField T="string" Label="First Name" Required="true" RequiredError="First name is required!" @bind-Value="newRecipient.FirstName" />
                        <MudTextField T="string" Label="Last Name" Required="true" RequiredError="Last name is required!" @bind-Value="newRecipient.LastName" />
                        <MudTextField T="string" Label="Phone Number" Required="true" RequiredError="Phone number is required!" @bind-Value="newRecipient.PhoneNumber"
                                      Validation="@(new Func<string, string>(ValidatePhoneNumber))"/>
                        <MudTextField T="string" Label="Email" Required="true" RequiredError="Email is required!"
                                      Validation="@(new EmailAddressAttribute() {ErrorMessage = "The email address is invalid"})" @bind-Value="newRecipient.Email"/>

                        <div class="d-flex align-center justify-space-between mt-4">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!recipientSuccess)" OnClick="AddRecipient" Class="ml-auto" Type="submit">Submit</MudButton>
                            <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="@ResetRecipientForm" Class="ml-2">Reset</MudButton>
                        </div>
                    </MudForm>
                </MudPaper>
            </MudItem>

            <!-- Pet Info Section -->
            <MudItem xs="12" sm="5">
                <MudPaper Class="pa-4 mud-height-full">
                    <MudForm @ref="petForm" @bind-IsValid="@petSuccess" @bind-Errors="@errors" OnValidSubmit="AddPet">
                        <MudText Typo="Typo.subtitle1">Add Pet</MudText>
                        
                        <MudTextField T="string" Label="Pet Name" Required="true" RequiredError="Pet name is required!" @bind-Value="newPet.Name" />
                        <MudTextField T="PetType" Label="Pet Type" Required="true" RequiredError="Pet type is required!" @bind-Value="newPet.Type" />
                        <MudTextField T="string" Label="Food Type" Required="true" RequiredError="Food type is required!" @bind-Value="newPet.FoodType" />
                        <MudTextField T="int" Label="Food Amount" Required="true" RequiredError="Food amount (pounds) is required!" @bind-Value="newPet.FoodAmount"/>

                        <div class="d-flex align-center justify-space-between mt-4">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!petSuccess)" OnClick="AddPet" Class="ml-auto" Type="submit">Add</MudButton>
                            <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="@ResetPetForm" Class="ml-2">Reset</MudButton>
                        </div>
                    </MudForm>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Recipient Info Update Section -->
        @if (selectedRecipient != null)
        {
            <MudPaper Class="pa-4 mt-4">
                <MudText Typo="Typo.h5">Selected Recipient: @selectedRecipient.FirstName @selectedRecipient.LastName</MudText>

                <MudTextField T="string" Label="Items Receiving" @bind-Value="selectedRecipient.ItemsReceiving" Placeholder="Enter items or information" />

                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SubmitRecipientInfo">
                    Submit
                </MudButton>
            </MudPaper>
        }
    </Authorized>

    <NotAuthorized></NotAuthorized>
</AuthorizeView>

@code {
    private MudForm recipientForm;
    private MudForm petForm;
    private bool petSuccess;
    private bool recipientSuccess;
    private string[] errors = { };
    private PetType[] petTypes = [ PetType.Dog, PetType.Cat, PetType.Other ];
    private Recipient? recipientToShowDate;

private void ShowAppointmentDate(Recipient recipient)
{
    recipientToShowDate = recipient;
}


    private Pet newPet = new Pet()
    {
        Type = PetType.Other
    };

    private Recipient newRecipient = new Recipient
    {
        Pets = new List<Pet>()
    };

    private Recipient? selectedRecipient;  // Track the selected recipient

    private string searchTerm = "";
    private List<Recipient> allRecipients = new();
    private IEnumerable<Recipient> filteredRecipients =>
        allRecipients
            .Where(r => $"{r.FirstName} {r.LastName}".Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
            .ToList();

    protected override async Task OnInitializedAsync()
    {
        allRecipients = await Context.Recipients.ToListAsync();
    }

    private void SelectRecipient(Recipient recipient)
    {
        selectedRecipient = recipient;  // Set the selected recipient
    }

    private async Task SubmitRecipientInfo()
    {
        try
        {
            // Update the selected recipient with the new ItemsReceiving info
            Context.Recipients.Update(selectedRecipient);
            await Context.SaveChangesAsync();

            // Optionally, reset the form or do other actions
            selectedRecipient = null;  // Reset selected recipient after submission
        }
        catch (Exception ex)
        {
            errors = new[] { "Error saving recipient info: " + ex.Message };
        }
    }

    private async Task AddPet()
    {
        newPet.Recipient = newRecipient;
        newPet.RecipientId = newRecipient.Id;
        
        newRecipient.Pets.Add(newPet);
        try
        {
            Context.Pets.Add(newPet);
            await Context.SaveChangesAsync();

            ResetPetForm();
        }
        catch (Exception ex)
        {
            errors = new[] { "Error adding pet: " + ex.Message };
        }
    }

    private string ValidatePhoneNumber(string phone)
    {
        if (string.IsNullOrWhiteSpace(phone))
            return "Phone number is required!";
        if (!System.Text.RegularExpressions.Regex.IsMatch(phone, @"^(\+\d{1,2}\s?)?1?\-?\.?\s?\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}$"))
            return "Phone number is improperly formatted";
        return null;
    }

    private async Task AddRecipient()
    {
        Console.WriteLine($"First Name: {newRecipient.FirstName}");
        Console.WriteLine($"Last Name: {newRecipient.LastName}");
        Console.WriteLine($"Email: {newRecipient.Email}");
        Console.WriteLine($"Phone: {newRecipient.PhoneNumber}");
        try
        {
            Context.Recipients.Add(newRecipient);
            await Context.SaveChangesAsync();

            ResetRecipientForm();
            allRecipients = await Context.Recipients.ToListAsync(); // refresh list
        }
        catch (Exception ex)
        {
            errors = new[] { "Error adding recipient: " + ex.Message };
        }
    }

    private void ResetRecipientForm()
    {
        newRecipient = new Recipient()
        {
            Pets = new List<Pet>()
        };
        recipientForm.ResetAsync();
        ResetPetForm();
    }

    private void ResetPetForm()
    {
        newPet = new Pet()
        {
            Type = PetType.Other
        };
        petForm.ResetAsync();
    }
}
